<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyoki Product Pricing Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5f1eb 0%, #e8ddd4 100%);
            color: #2c2c2c;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .nav-buttons {
            display: flex;
            border-bottom: 1px solid #e8ddd4;
        }

        .nav-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #6b5b73;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #f9f7f4;
        }

        .nav-btn.active {
            background: #6b5b73;
            color: white;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .group-header {
            background: linear-gradient(135deg, #f9f7f4 0%, #e8ddd4 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0 15px;
            border-left: 4px solid;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .logo-placeholder {
            width: 120px;
            height: 60px;
            background: #8b7355;
            border-radius: 8px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        h1 {
            color: #6b5b73;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b7355;
            font-style: italic;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e8ddd4;
        }

        .card h2 {
            color: #6b5b73;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #e8ddd4;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #5a4a4a;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8ddd4;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8b7355;
        }

        .btn {
            background: #6b5b73;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #5a4a61;
        }

        .btn-secondary {
            background: #8b7355;
        }

        .btn-secondary:hover {
            background: #7a6449;
        }

        .btn-danger {
            background: #c17b7b;
        }

        .btn-danger:hover {
            background: #b36969;
        }

        .btn-edit {
            background: #7ba05b;
        }

        .btn-edit:hover {
            background: #6a8f4f;
        }

        .edit-mode {
            border: 3px solid #7ba05b;
            background: #f0f8e8;
        }

        .edit-indicator {
            background: #7ba05b;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
        }

        .material-item {
            background: #f9f7f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #8b7355;
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .material-cost {
            font-weight: bold;
            color: #6b5b73;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e8ddd4;
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 20px;
        }

        .product-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #6b5b73;
            margin-bottom: 10px;
        }

        .profit-analysis {
            background: #f9f7f4;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .profit-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .profit-row.total {
            border-top: 2px solid #8b7355;
            padding-top: 8px;
            font-weight: bold;
            color: #6b5b73;
        }

        .hidden {
            display: none;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #8b7355;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            transition: background 0.3s ease;
        }

        .file-input-label:hover {
            background: #7a6449;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .nav-btn {
                border-bottom: 1px solid #e8ddd4;
            }
            
            .nav-btn:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-placeholder">NYOKI</div>
            <h1>Product Pricing Calculator</h1>
            <p class="subtitle">Where tradition meets modern pricing</p>
        </div>

        <div class="nav-menu">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showView('add-edit')">Add/Edit Product</button>
                <button class="nav-btn" onclick="showView('view-products')">View Products</button>
                <button class="nav-btn" onclick="showView('manage-groups')">Manage Groups</button>
            </div>
        </div>

        <!-- Add/Edit Product View -->
        <div id="add-edit-view" class="view-section active">
            <div class="main-content">
                <div class="card">
                    <h2>Create New Product</h2>
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" placeholder="Enter product name">
                    </div>

                    <div class="form-group">
                        <label for="productGroup">Product Group</label>
                        <select id="productGroup">
                            <option value="">No Group</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productImage">Product Image</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="productImage" accept="image/*">
                            <label for="productImage" class="file-input-label">Choose Image</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="laborCost">Labor Cost (£)</label>
                        <input type="number" id="laborCost" step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="overheadCost">Overhead Cost (£)</label>
                        <input type="number" id="overheadCost" step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="postCost">Post & Shipping Cost (£)</label>
                        <input type="number" id="postCost" step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="packagingCost">Packaging Cost (£)</label>
                        <input type="number" id="packagingCost" step="0.01" placeholder="0.00">
                    </div>

                    <h3 style="color: #6b5b73; margin: 20px 0 15px;">Materials</h3>
                    <div class="form-group">
                        <label for="materialName">Material Name</label>
                        <input type="text" id="materialName" placeholder="e.g., Cotton fabric">
                    </div>

                    <div class="form-group">
                        <label for="materialCost">Material Cost (£)</label>
                        <input type="number" id="materialCost" step="0.01" placeholder="0.00">
                    </div>

                    <button class="btn btn-secondary" onclick="addMaterial()">Add Material</button>

                    <div id="materialsList"></div>

                    <h3 style="color: #6b5b73; margin: 20px 0 15px;">Pricing</h3>
                    <div class="form-group">
                        <label for="marginPercent">Desired Margin (%)</label>
                        <input type="number" id="marginPercent" placeholder="50" min="0" max="1000">
                    </div>

                    <div class="form-group">
                        <label for="retailPrice">Or Set Retail Price (£)</label>
                        <input type="number" id="retailPrice" step="0.01" placeholder="0.00">
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="saveProduct()">Save Product</button>
                        <button class="btn btn-secondary" onclick="showView('view-products')" style="margin-left: 10px;">View All Products</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Cost Breakdown</h2>
                    <div id="costBreakdown">
                        <p style="text-align: center; color: #999; font-style: italic;">Add materials to see cost breakdown</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Products View -->
        <div id="view-products-view" class="view-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Your Products</h2>
                    <div>
                        <select id="filterByGroup" onchange="filterProductsByGroup()" style="margin-right: 10px; padding: 8px; border: 2px solid #e8ddd4; border-radius: 6px;">
                            <option value="">All Groups</option>
                        </select>
                        <button class="btn" onclick="showView('add-edit')">Add New Product</button>
                    </div>
                </div>
                <div id="productsList" class="product-grid">
                    <p style="text-align: center; color: #999; font-style: italic; grid-column: 1/-1;">No products created yet</p>
                </div>
            </div>
        </div>

        <!-- Manage Groups View -->
        <div id="manage-groups-view" class="view-section">
            <div class="main-content">
                <div class="card">
                    <h2>Create New Group</h2>
                    <div class="form-group">
                        <label for="groupName">Group Name</label>
                        <input type="text" id="groupName" placeholder="Enter group name">
                    </div>

                    <div class="form-group">
                        <label for="groupDescription">Description (Optional)</label>
                        <textarea id="groupDescription" placeholder="Describe this product group" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="groupColor">Group Color</label>
                        <input type="color" id="groupColor" value="#6b5b73">
                    </div>

                    <button class="btn" onclick="saveGroup()">Save Group</button>
                </div>

                <div class="card">
                    <h2>Existing Groups</h2>
                    <div id="groupsList">
                        <p style="text-align: center; color: #999; font-style: italic;">No groups created yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Using JavaScript closures to create a product management system
        const ProductManager = (function() {
            let products = [];
            let materials = [];
            let groups = [];
            let productCounter = 0;
            let groupCounter = 0;
            let isEditing = false;
            let editingProductIndex = -1;
            let editingMaterialIndex = -1;
            let isEditingGroup = false;
            let editingGroupIndex = -1;

            // LOCAL STORAGE NOTE:
            // localStorage is not supported in Claude.ai artifacts environment
            // To add localStorage when using this code elsewhere, uncomment the functions below:
            
            /*
            // Save products to localStorage
            function saveToLocalStorage() {
                localStorage.setItem('nyoki_products', JSON.stringify(products));
                localStorage.setItem('nyoki_counter', productCounter.toString());
            }

            // Load products from localStorage
            function loadFromLocalStorage() {
                const savedProducts = localStorage.getItem('nyoki_products');
                const savedCounter = localStorage.getItem('nyoki_counter');

                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                }
                if (savedCounter) {
                    productCounter = parseInt(savedCounter);
                }
                renderProducts();
            }
            */

            // Group storage helpers
            function saveGroupsToStorage() {
                localStorage.setItem('nyoki_groups', JSON.stringify(groups));
                localStorage.setItem('nyoki_group_counter', groupCounter.toString());
            }

            function loadGroupsFromStorage() {
                const savedGroups = localStorage.getItem('nyoki_groups');
                const savedGroupCounter = localStorage.getItem('nyoki_group_counter');
                if (savedGroups) {
                    groups = JSON.parse(savedGroups);
                }
                if (savedGroupCounter) {
                    groupCounter = parseInt(savedGroupCounter);
                } else {
                    groupCounter = groups.reduce((max, g) => Math.max(max, g.id || 0), 0);
                }
            }

            function renderGroups() {
                const container = document.getElementById('groupsList');
                if (!groups.length) {
                    container.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No groups created yet</p>';
                    return;
                }
                container.innerHTML = groups.map((g, idx) => {
                    if (isEditingGroup && editingGroupIndex === idx) {
                        return `
                            <div class="group-item" style="border-left: 4px solid ${g.color}; padding: 8px; margin-bottom: 8px;">
                                <input type="text" id="editGroupName_${idx}" value="${g.name}" style="width:100%; margin-bottom:5px;">
                                <textarea id="editGroupDescription_${idx}" rows="2" style="width:100%; margin-bottom:5px;">${g.description || ''}</textarea>
                                <input type="color" id="editGroupColor_${idx}" value="${g.color}">
                                <div style="margin-top:5px;">
                                    <button class="btn btn-edit" onclick="ProductManager.saveGroupEdit(${idx})">Save</button>
                                    <button class="btn" onclick="ProductManager.cancelGroupEdit()">Cancel</button>
                                </div>
                            </div>`;
                    }
                    return `
                        <div class="group-item" style="border-left: 4px solid ${g.color}; padding: 8px; margin-bottom: 8px; display:flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${g.name}</strong>
                                ${g.description ? `<div style="font-size:0.9em; color:#666;">${g.description}</div>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-edit" onclick="ProductManager.editGroup(${idx})" style="margin-right:5px;">Edit</button>
                                <button class="btn btn-danger" onclick="ProductManager.removeGroup(${idx})">Delete</button>
                            </div>
                        </div>`;
                }).join('');
            }

            function populateGroupDropdowns() {
                const productSelect = document.getElementById('productGroup');
                const filterSelect = document.getElementById('filterByGroup');

                const options = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                if (productSelect) {
                    productSelect.innerHTML = '<option value="">No Group</option>' + options;
                }
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Groups</option>' + options;
                }
            }

            // Private function to calculate costs
            function calculateCosts() {
                const laborCost = parseFloat(document.getElementById('laborCost').value) || 0;
                const overheadCost = parseFloat(document.getElementById('overheadCost').value) || 0;
                const postCost = parseFloat(document.getElementById('postCost').value) || 0;
                const packagingCost = parseFloat(document.getElementById('packagingCost').value) || 0;
                const materialsCost = materials.reduce((total, material) => total + material.cost, 0);
                const totalCost = laborCost + overheadCost + postCost + packagingCost + materialsCost;
                
                return {
                    laborCost,
                    overheadCost,
                    postCost,
                    packagingCost,
                    materialsCost,
                    totalCost
                };
            }

            // Private function to update cost breakdown display
            function updateCostBreakdown() {
                const costs = calculateCosts();
                const marginPercent = parseFloat(document.getElementById('marginPercent').value) || 0;
                const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;

                let calculatedRetailPrice = costs.totalCost * (1 + marginPercent / 100);
                let calculatedMargin = retailPrice > 0 ? ((retailPrice - costs.totalCost) / costs.totalCost * 100) : marginPercent;
                let profit = (retailPrice > 0 ? retailPrice : calculatedRetailPrice) - costs.totalCost;

                const breakdown = document.getElementById('costBreakdown');
                breakdown.innerHTML = `
                    <div class="profit-analysis">
                        <div class="profit-row">
                            <span>Materials Cost:</span>
                            <span>£${costs.materialsCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row">
                            <span>Labor Cost:</span>
                            <span>£${costs.laborCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row">
                            <span>Overhead Cost:</span>
                            <span>£${costs.overheadCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row">
                            <span>Post & Shipping:</span>
                            <span>£${costs.postCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row">
                            <span>Packaging Cost:</span>
                            <span>£${costs.packagingCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row total">
                            <span>Total Cost:</span>
                            <span>£${costs.totalCost.toFixed(2)}</span>
                        </div>
                        <div class="profit-row total">
                            <span>Retail Price:</span>
                            <span>£${(retailPrice > 0 ? retailPrice : calculatedRetailPrice).toFixed(2)}</span>
                        </div>
                        <div class="profit-row total">
                            <span>Profit:</span>
                            <span>£${profit.toFixed(2)}</span>
                        </div>
                        <div class="profit-row total">
                            <span>Margin:</span>
                            <span>${calculatedMargin.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }

            // Private function to render materials list
            function renderMaterials() {
                const materialsList = document.getElementById('materialsList');
                materialsList.innerHTML = materials.map((material, index) => {
                    if (editingMaterialIndex === index) {
                        // Edit mode for this material
                        return `
                            <div class="material-item" style="border-left-color: #7ba05b;">
                                <div class="material-header">
                                    <div style="flex: 1;">
                                        <input type="text" id="editMaterialName_${index}" value="${material.name}" 
                                               style="width: 100%; margin-bottom: 8px; padding: 8px; border: 2px solid #7ba05b; border-radius: 4px;">
                                        <input type="number" id="editMaterialCost_${index}" value="${material.cost}" step="0.01"
                                               style="width: 100%; padding: 8px; border: 2px solid #7ba05b; border-radius: 4px;">
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-edit" onclick="ProductManager.saveMaterialEdit(${index})" style="margin-right: 5px;">Save</button>
                                    <button class="btn" onclick="ProductManager.cancelMaterialEdit()" style="margin-right: 5px;">Cancel</button>
                                    <button class="btn btn-danger" onclick="ProductManager.removeMaterial(${index})">Remove</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // View mode for this material
                        return `
                            <div class="material-item">
                                <div class="material-header">
                                    <span><strong>${material.name}</strong></span>
                                    <span class="material-cost">£${material.cost.toFixed(2)}</span>
                                </div>
                                <div>
                                    <button class="btn btn-edit" onclick="ProductManager.editMaterial(${index})" style="margin-right: 5px;">Edit</button>
                                    <button class="btn btn-danger" onclick="ProductManager.removeMaterial(${index})">Remove</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                updateCostBreakdown();
            }

            // Private function to render products
            function renderProducts(filterGroupId = '') {
                const productsList = document.getElementById('productsList');
                
                let filteredProducts = products;
                if (filterGroupId) {
                    filteredProducts = products.filter(p => p.groupId === filterGroupId);
                }
                
                if (filteredProducts.length === 0) {
                    const message = filterGroupId ? 'No products in this group' : 'No products created yet';
                    productsList.innerHTML = `<p style="text-align: center; color: #999; font-style: italic; grid-column: 1/-1;">${message}</p>`;
                    return;
                }

                // Group products by groupId
                const groupedProducts = {};
                const ungroupedProducts = [];
                
                filteredProducts.forEach(product => {
                    if (product.groupId) {
                        if (!groupedProducts[product.groupId]) {
                            groupedProducts[product.groupId] = [];
                        }
                        groupedProducts[product.groupId].push(product);
                    } else {
                        ungroupedProducts.push(product);
                    }
                });

                let html = '';

                // Render grouped products
                Object.keys(groupedProducts).forEach(groupId => {
                    const group = groups.find(g => g.id === parseInt(groupId));
                    const groupProducts = groupedProducts[groupId];
                    
                    html += `
                        <div style="grid-column: 1/-1; margin: 20px 0 10px;">
                            <h3 style="color: ${group ? group.color : '#6b5b73'}; border-bottom: 2px solid ${group ? group.color : '#6b5b73'}; padding-bottom: 5px;">
                                ${group ? group.name : 'Unknown Group'} (${groupProducts.length} product${groupProducts.length !== 1 ? 's' : ''})
                            </h3>
                        </div>
                    `;
                    
                    groupProducts.forEach((product, index) => {
                        const actualIndex = products.indexOf(product);
                        html += generateProductCard(product, actualIndex);
                    });
                });

                // Render ungrouped products
                if (ungroupedProducts.length > 0) {
                    html += `
                        <div style="grid-column: 1/-1; margin: 20px 0 10px;">
                            <h3 style="color: #999; border-bottom: 2px solid #999; padding-bottom: 5px;">
                                Ungrouped Products (${ungroupedProducts.length} product${ungroupedProducts.length !== 1 ? 's' : ''})
                            </h3>
                        </div>
                    `;
                    
                    ungroupedProducts.forEach(product => {
                        const actualIndex = products.indexOf(product);
                        html += generateProductCard(product, actualIndex);
                    });
                }

                productsList.innerHTML = html;
            }

            // Helper function to generate product card HTML
            function generateProductCard(product, index) {
                return `
                    <div class="product-card">
                        <div class="product-image">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}">` : 'No image'}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="profit-analysis">
                                <div class="profit-row">
                                    <span>Materials Cost:</span>
                                    <span>£${product.materials.reduce((sum, m) => sum + m.cost, 0).toFixed(2)}</span>
                                </div>
                                <div class="profit-row">
                                    <span>Labor Cost:</span>
                                    <span>£${product.laborCost.toFixed(2)}</span>
                                </div>
                                <div class="profit-row">
                                    <span>Overhead Cost:</span>
                                    <span>£${product.overheadCost.toFixed(2)}</span>
                                </div>
                                <div class="profit-row">
                                    <span>Post & Shipping:</span>
                                    <span>£${(product.postCost || 0).toFixed(2)}</span>
                                </div>
                                <div class="profit-row">
                                    <span>Packaging Cost:</span>
                                    <span>£${(product.packagingCost || 0).toFixed(2)}</span>
                                </div>
                                <div class="profit-row total">
                                    <span>Total Cost:</span>
                                    <span>£${product.totalCost.toFixed(2)}</span>
                                </div>
                                <div class="profit-row">
                                    <span>Retail Price:</span>
                                    <span>£${product.retailPrice.toFixed(2)}</span>
                                </div>
                                <div class="profit-row total">
                                    <span>Profit:</span>
                                    <span>£${product.profit.toFixed(2)}</span>
                                </div>
                                <div class="profit-row total">
                                    <span>Margin:</span>
                                    <span>${product.margin.toFixed(1)}%</span>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div><strong>Materials:</strong></div>
                                    ${product.materials.map(m => `<div style="font-size: 0.9em; color: #666;">• ${m.name}: £${m.cost.toFixed(2)}</div>`).join('')}
                                </div>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-edit" onclick="ProductManager.editProduct(${index})">Edit Product</button>
                                <button class="btn btn-danger" onclick="ProductManager.removeProduct(${index})">Delete Product</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Public methods using closure
            return {
                addMaterial: function() {
                    const name = document.getElementById('materialName').value.trim();
                    const cost = parseFloat(document.getElementById('materialCost').value);

                    if (!name || isNaN(cost) || cost < 0) {
                        alert('Please enter valid material name and cost');
                        return;
                    }

                    materials.push({ name, cost });
                    document.getElementById('materialName').value = '';
                    document.getElementById('materialCost').value = '';
                    renderMaterials();
                },

                removeMaterial: function(index) {
                    // Cancel any material edit in progress
                    if (editingMaterialIndex === index) {
                        editingMaterialIndex = -1;
                    } else if (editingMaterialIndex > index) {
                        editingMaterialIndex--;
                    }
                    
                    materials.splice(index, 1);
                    renderMaterials();
                },

                editMaterial: function(index) {
                    // Cancel any other material edit in progress
                    editingMaterialIndex = index;
                    renderMaterials();
                },

                saveMaterialEdit: function(index) {
                    const nameInput = document.getElementById(`editMaterialName_${index}`);
                    const costInput = document.getElementById(`editMaterialCost_${index}`);
                    
                    const newName = nameInput.value.trim();
                    const newCost = parseFloat(costInput.value);
                    
                    if (!newName || isNaN(newCost) || newCost < 0) {
                        alert('Please enter valid material name and cost');
                        return;
                    }
                    
                    materials[index] = {
                        name: newName,
                        cost: newCost
                    };
                    
                    editingMaterialIndex = -1;
                    renderMaterials();
                },

                cancelMaterialEdit: function() {
                    editingMaterialIndex = -1;
                    renderMaterials();
                },

                saveProduct: function() {
                    const name = document.getElementById('productName').value.trim();
                    const imageFile = document.getElementById('productImage').files[0];
                    
                    if (!name) {
                        alert('Please enter a product name');
                        return;
                    }

                    if (materials.length === 0) {
                        alert('Please add at least one material');
                        return;
                    }

                    const costs = calculateCosts();
                    const marginPercent = parseFloat(document.getElementById('marginPercent').value) || 0;
                    const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;

                    const finalRetailPrice = retailPrice > 0 ? retailPrice : costs.totalCost * (1 + marginPercent / 100);
                    const finalMargin = ((finalRetailPrice - costs.totalCost) / costs.totalCost) * 100;
                    const profit = finalRetailPrice - costs.totalCost;

                    const productData = {
                        name,
                        groupId: document.getElementById('productGroup').value || null,
                        materials: [...materials],
                        laborCost: costs.laborCost,
                        overheadCost: costs.overheadCost,
                        postCost: costs.postCost,
                        packagingCost: costs.packagingCost,
                        totalCost: costs.totalCost,
                        retailPrice: finalRetailPrice,
                        margin: finalMargin,
                        profit
                    };

                    const saveProductData = (imageData = null) => {
                        if (imageData) {
                            productData.image = imageData;
                        }

                        if (isEditing) {
                            // Update existing product
                            const existingProduct = products[editingProductIndex];
                            productData.id = existingProduct.id;
                            if (!imageData && existingProduct.image) {
                                productData.image = existingProduct.image;
                            }
                            products[editingProductIndex] = productData;
                            this.cancelEdit();
                        } else {
                            // Create new product
                            productData.id = ++productCounter;
                            products.push(productData);
                        }

                        renderProducts();
                        this.clearForm();
                        // When using outside Claude.ai, add: saveToLocalStorage();
                        
                        // Switch to view products after saving
                        if (!isEditing) {
                            showView('view-products');
                        }
                    };

                    // Handle image if provided
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            saveProductData(e.target.result);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        saveProductData();
                    }
                },

                removeProduct: function(index) {
                    if (confirm('Are you sure you want to delete this product?')) {
                        products.splice(index, 1);
                        renderProducts();
                        // When using outside Claude.ai, add: saveToLocalStorage();
                    }
                },

                editProduct: function(index) {
                    const product = products[index];
                    isEditing = true;
                    editingProductIndex = index;
                    editingMaterialIndex = -1; // Reset material editing

                    // Populate form with product data
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productGroup').value = product.groupId || '';
                    document.getElementById('laborCost').value = product.laborCost;
                    document.getElementById('overheadCost').value = product.overheadCost;
                    document.getElementById('postCost').value = product.postCost || 0;
                    document.getElementById('packagingCost').value = product.packagingCost || 0;
                    document.getElementById('retailPrice').value = product.retailPrice;

                    // Calculate margin from current data
                    const calculatedMargin = ((product.retailPrice - product.totalCost) / product.totalCost) * 100;
                    document.getElementById('marginPercent').value = calculatedMargin.toFixed(1);

                    // Load materials
                    materials = [...product.materials];
                    renderMaterials();

                    // Update UI to show edit mode
                    this.updateEditMode();

                    // Scroll to form
                    showView('add-edit');
                    document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' });
                },

                cancelEdit: function() {
                    isEditing = false;
                    editingProductIndex = -1;
                    editingMaterialIndex = -1;
                    this.updateEditMode();
                    this.clearForm();
                },

                clearForm: function() {
                    document.getElementById('productName').value = '';
                    document.getElementById('productGroup').value = '';
                    document.getElementById('productImage').value = '';
                    document.getElementById('laborCost').value = '';
                    document.getElementById('overheadCost').value = '';
                    document.getElementById('postCost').value = '';
                    document.getElementById('packagingCost').value = '';
                    document.getElementById('marginPercent').value = '';
                    document.getElementById('retailPrice').value = '';
                    materials = [];
                    editingMaterialIndex = -1;
                    renderMaterials();
                },

                updateEditMode: function() {
                    const createCard = document.querySelector('.main-content .card');
                    const cardHeader = createCard.querySelector('h2');
                    const editIndicator = document.getElementById('editIndicator');
                    const saveButton = document.querySelector('.btn[onclick="saveProduct()"]');
                    
                    if (isEditing) {
                        createCard.classList.add('edit-mode');
                        cardHeader.textContent = 'Edit Product';
                        
                        if (!editIndicator) {
                            const indicator = document.createElement('div');
                            indicator.id = 'editIndicator';
                            indicator.className = 'edit-indicator';
                            indicator.innerHTML = `
                                Editing Product: ${products[editingProductIndex].name}
                                <button class="btn" onclick="ProductManager.cancelEdit()" style="margin-left: 15px; padding: 4px 12px; font-size: 12px;">Cancel Edit</button>
                            `;
                            createCard.insertBefore(indicator, createCard.firstChild.nextSibling);
                        }
                        saveButton.textContent = 'Update Product';
                    } else {
                        createCard.classList.remove('edit-mode');
                        cardHeader.textContent = 'Create New Product';
                        
                        if (editIndicator) {
                            editIndicator.remove();
                        }
                        saveButton.textContent = 'Save Product';
                    }
                },

                updateBreakdown: updateCostBreakdown,

                // Group management functions
                saveGroup: function() {
                    const name = document.getElementById('groupName').value.trim();
                    const description = document.getElementById('groupDescription').value.trim();
                    const color = document.getElementById('groupColor').value;

                    if (!name) {
                        alert('Please enter a group name');
                        return;
                    }

                    const groupData = {
                        name,
                        description,
                        color
                    };

                    if (isEditingGroup) {
                        // Update existing group
                        const existingGroup = groups[editingGroupIndex];
                        groupData.id = existingGroup.id;
                        groups[editingGroupIndex] = groupData;
                        this.cancelGroupEdit();
                    } else {
                        // Create new group
                        groupData.id = ++groupCounter;
                        groups.push(groupData);
                    }

                    renderGroups();
                    populateGroupDropdowns();
                    saveGroupsToStorage();
                    this.clearGroupForm();
                },

                editGroup: function(index) {
                    const group = groups[index];
                    isEditingGroup = true;
                    editingGroupIndex = index;
                    renderGroups();
                },

                saveGroupEdit: function(index) {
                    const nameInput = document.getElementById(`editGroupName_${index}`);
                    const descriptionInput = document.getElementById(`editGroupDescription_${index}`);
                    const colorInput = document.getElementById(`editGroupColor_${index}`);
                    
                    const newName = nameInput.value.trim();
                    const newDescription = descriptionInput.value.trim();
                    const newColor = colorInput.value;
                    
                    if (!newName) {
                        alert('Please enter a valid group name');
                        return;
                    }
                    
                    groups[index] = {
                        id: groups[index].id,
                        name: newName,
                        description: newDescription,
                        color: newColor
                    };
                    
                    isEditingGroup = false;
                    editingGroupIndex = -1;
                    renderGroups();
                    populateGroupDropdowns();
                    saveGroupsToStorage();
                },

                cancelGroupEdit: function() {
                    isEditingGroup = false;
                    editingGroupIndex = -1;
                    renderGroups();
                },

                removeGroup: function(index) {
                    const group = groups[index];
                    const productsInGroup = products.filter(p => p.groupId === group.id).length;
                    
                    let confirmMessage = `Are you sure you want to delete the group "${group.name}"?`;
                    if (productsInGroup > 0) {
                        confirmMessage += `\n\nThis will ungroup ${productsInGroup} product${productsInGroup !== 1 ? 's' : ''}, but the products will not be deleted.`;
                    }
                    
                    if (confirm(confirmMessage)) {
                        // Remove group reference from products
                        products.forEach(product => {
                            if (product.groupId === group.id) {
                                product.groupId = null;
                            }
                        });
                        
                        groups.splice(index, 1);
                        renderGroups();
                        populateGroupDropdowns();
                        renderProducts();
                        saveGroupsToStorage();
                    }
                },

                clearGroupForm: function() {
                    document.getElementById('groupName').value = '';
                    document.getElementById('groupDescription').value = '';
                    document.getElementById('groupColor').value = '#6b5b73';
                },

                // Initialize groups
                init: function() {
                    loadGroupsFromStorage();
                    populateGroupDropdowns();
                    renderGroups();
                    renderProducts();
                },

                renderProducts: function(filterGroupId) {
                    renderProducts(filterGroupId);
                },

                // Uncomment when using outside Claude.ai:
                // loadFromLocalStorage: loadFromLocalStorage
            };
        })();

        // Global functions for button clicks
        function addMaterial() {
            ProductManager.addMaterial();
        }

        function saveProduct() {
            ProductManager.saveProduct();
        }

        function saveGroup() {
            ProductManager.saveGroup();
        }

        function filterProductsByGroup() {
            const filterSelect = document.getElementById('filterByGroup');
            const selectedGroupId = filterSelect.value;
            ProductManager.renderProducts(selectedGroupId);
        }

        // Navigation function
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected view and activate corresponding button
            if (viewName === 'add-edit') {
                document.getElementById('add-edit-view').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else if (viewName === 'view-products') {
                document.getElementById('view-products-view').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
            } else if (viewName === 'manage-groups') {
                document.getElementById('manage-groups-view').classList.add('active');
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
            }
        }

        // Event listeners for real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['laborCost', 'overheadCost', 'postCost', 'packagingCost', 'marginPercent', 'retailPrice'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', ProductManager.updateBreakdown);
            });
            
            // Initialize the app
            ProductManager.init();
            
            // When using outside Claude.ai, add: ProductManager.loadFromLocalStorage();
        });
    </script>
</body>
</html>
